--- Daily revenue---
select order_date, sum(order_amount) as daily_revenue
from orders
group by order_date
order by order_date;


-- Monthly Revenue
SELECT
    DATE_FORMAT(order_date, '%Y-%m-01') AS sales_month,
    SUM(order_amount) AS monthly_revenue
FROM orders
GROUP BY sales_month
ORDER BY sales_month;


--Monthly Revenue + Month-over-Month (MoM) Growth %--

with monthly_sales as(
select
 DATE_FORMAT(order_date, '%Y-%m-01') AS sales_month,
    SUM(order_amount) AS monthly_revenue
    from orders
    group by sales_month
)
   select sales_month,monthly_revenue,LAG(monthly_revenue) OVER (ORDER BY sales_month) AS prev_month_revenue,
    ROUND(
        (monthly_revenue - LAG(monthly_revenue) OVER (ORDER BY sales_month))
        / LAG(monthly_revenue) OVER (ORDER BY sales_month) * 100,
        2
    ) AS mom_growth_pct
FROM monthly_sales
order by sales_month;

---7 Day rolling average--

WITH daily_revenue AS (
    SELECT
        order_date,
        SUM(order_amount) AS daily_revenue
    FROM orders
    GROUP BY order_date
)select order_date, daily_revenue, ROUND(
        AVG(daily_revenue) OVER (
            ORDER BY order_date
            ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
        ), 2
    ) AS rolling_7_day_avg
    from daily_revenue
    order by order_date;

--- top 5 customer by total spend

select c.customer_id,c.customer_name,sum(o.order_amount) as total_spend
from customers c join orders o on
 c.customer_id=o.customer_id
 group by c.customer_id,c.customer_name
 order by total_spend desc
 limit 5;

--Revenue contribution per city

select c.city,sum(o.order_amount) as city_revenue
from customers c join orders o
on c.customer_id=o.customer_id
group by city
order by city desc;

--Customer ranking using window function

select c.customer_id,c.customer_name,
sum(o.order_amount) as total_spend,
rank()over(
order by sum(o.order_amount) desc

)as rnk
from customers c join orders o
on c.customer_id=o.customer_id
group by c.customer_id,c.customer_name;

--First order date per customer

select customer_id,min(order_date) as first_order
from orders 
group by customer_id;


---A repeat customer = more than 1 order

select customer_id,count(order_id) as total_order
from orders 
group by customer_id
having count(order_id)>1;

---Count of new vs repeat customers

with customer_order as(
select customer_id,count(order_id) as total_order
from orders 
group by customer_id
)
select 
   case when total_order=1 then 'new customer'
      else 'repeat customer'
      end as customer_type,
      COUNT(*) AS customer_count
FROM customer_order
GROUP BY customer_type;
        

